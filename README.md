# NTU canoebot
If you are able to access this repo, you are able to download and host your own canoebot!

---
## Prerequisites

### For Debian/Ubuntu-based systems:
Install the venv package for python3 by running:

`sudo apt install python3-venv`

Install the dependency for lxml by running:

`sudo apt install libxslt-dev`

### For Raspberry Pi (3B and up, zero 2)
Install the numpy c-extensions by running:

`sudo apt install libatlas-base-dev`

---

## Installing
This bot is designed to work on Linux-based systems E.g. Debian, Arch, WSL.
1. Fork this repository

    [Create a personal access token.](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token#creating-a-token)
    If you plan to run the bot based off this repo, you will need to request for
    access and then create a personal access token.

2. clone the repository using the command below:

    `git clone "https://{username}:{access_token}@github.com/{username}/NTU_canoebot.git"`

    where username: your username (if you've cloned it)

    where access_token: your generated access token.

    This step is important, as it allows the bot to perform a shallow pull
    without authenticating again.

3. Navigate to the repository using:

    `cd /path/to/this/repo`

4. Install python dependencies by running the install script:

    `bash .scripts/install.sh`

    This script installs the necessary python modules in a virtual environment,
    adds bash aliases to start/stop/view logs, and sets up crontabs.

---

## Uninstalling
Navigate to the source directory and run:

`bash .scripts/uninstall.sh`

This removes all installed bash aliases, crontabs and the python virtual environment.

---

## Configuring settings
Now that the bot has been installed, it needs to be set up to point to all the necessary Google resource IDs in order to function properly.
Navigate to the following directory:

`cd .configs && ls -al`

Note the files that contain "template" in them.
These will be the only files that require modification.
Let's go over what needs to be modified for each file.

### botsettings.template.json
This file contains common settings shared between the debug and deployed versions of the bot.
For the most part, this file does not need to be modified.

### botsettings.template.deploy.json
This file contains private parameters (API keys, google sheet IDs)
The example file for reference is `botsettings.template.d.json`.
Create a copy of this file and rename it to `botsettings.template.deploy.json`.
Add the API key for the deployed version of the bot, google forms resource IDs, and set the logging level to "INFO" to show informational logs and above.

### botsettings.template.debug.json
This file also takes reference to `botsettings.template.d.json`.
Follow the same procedure as above, but name the file `botsettings.template.debug.json` instead.
Change the API key to a different bot, and change the log level to "DEBUG".

### Review
Altogether there should now be 3 'template' JSON files inside `.configs`:
- `botsettings.template.json`
- `botsettings.template.deploy.json`
- `botsettings.template.debug.json`

During startup, these files will be read and merged, creatiing 2 more files:
- `botsettings.json`: Actual deployed configuration file read in by canoebot
- `botsettings.debug.json`: Debug configuration file

Do not modifiy those files, they will change with every startup if any of the template files are modified.

---

## Usage: command line
After running the install script there should be 8 new bash aliases added to your `~/.bash_aliases` file:

1. `canoebotrestart`
2. `canoebotstop`
3. `canoebotlog`
4. `canoebotupdate`
5. `canoebotdeploy`
6. `canoebotdebug`
7. `canoebotvenventer`
8. `canoebotvenvexit`

You will need to run `source ~/.bash_aliases` in order for these to show up.

### Aliases 1-3:
**#1** is used to start/restart the bot.
Any modifications to code or configs should be reflected on the new startup.

**#2** is used to stop the bot.

**#3** shows a rolling output of the logs generated by the bot.
This is useful when debugging or tracing back exceptions during runtime.
A log file in `.scripts/canoebot.log` contains logs from the most recent
startup of the bot.

### Aliases 4-6
Used when updating the bot.

**#4** pulls directly from this repo (or yours, if you've forked it).
So any buggy code that has not been fixed will be pulled as well.

**#5** is used to switch to deploy mode. This needs to be run after executing
an update.

**#6** is used to switch to debug mode.

### Aliases 7-8
**#7** is used to enter the python virtual environment containing bot
dependencies. Used when debugging,

**#8** exits the python virtual environment. Remember to exit this venv after
use!

---

## Setup: Telegram
These are the current list of public commands available. Copy and paste these when [setting commands with BotFather:](https://core.telegram.org/bots#botfather-commands)

    help - help
    reload - refresh sheet data
    whoami - who u
    uptime - power on time
    src - view SRC facilities
    countdown - days left to ITCC
    traininglog - daily training log
    namelist - see who's going training
    training - view training program
    paddling - full paddling attendance
    logsheet - SCF logsheet

---

## Usage: interaction

<img src=".media/canoebot_interaction_512p.gif" alt="Interacting with the bot" width="400"/>

